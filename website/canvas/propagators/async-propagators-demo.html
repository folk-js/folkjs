<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Async Propagators Demo</title>
    <style>
      html {
        height: 100%;
      }

      body {
        min-height: 100%;
        position: relative;
        margin: 0;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          'Segoe UI',
          Roboto,
          sans-serif;
        padding: 20px;
      }

      folk-shape {
        background-color: black;
        border-radius: 5px;
        color: white;
        padding: 5px 10px;
        z-index: 10;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .controls {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
      }

      button {
        padding: 8px 16px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background-color: #f8f8f8;
        cursor: pointer;
      }

      button:hover {
        background-color: #e8e8e8;
      }

      .section {
        margin-bottom: 40px;
      }

      h2 {
        margin-top: 40px;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
      }

      #apiResponse {
        margin-top: 20px;
        padding: 10px;
        background-color: #f0f0f0;
        border-radius: 4px;
        max-width: 800px;
        white-space: pre-wrap;
        min-height: 100px;
      }

      .description {
        margin-bottom: 15px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>Async Propagators Demo</h1>
    <p>This demo shows how async propagators can wait for promises to resolve before applying changes.</p>

    <div id="apiResponse">API responses will appear here...</div>

    <h2>Method 1: Explicit async flag</h2>
    <div class="description"> This propagator explicitly sets async="true" to handle await expressions. </div>

    <div class="section">
      <div class="controls">
        <button id="fetchButton1">Fetch data for box 1</button>
      </div>

      <folk-shape id="box1" x="100" y="200" width="200" height="100">Click or use button</folk-shape>
      <folk-shape id="box2" x="400" y="200" width="250" height="100">Updates after both async calls</folk-shape>

      <folk-event-propagator
        source="#box1"
        target="#box2"
        trigger="click"
        async="true"
        expression="x: to.x + 10
y: to.y + 10
backgroundColor: await fetchRandomColor('Box 2')
textContent: 'Data: ' + await fetchRandomData('Box 2')"
      ></folk-event-propagator>
    </div>

    <h2>Method 2: Auto-detection of await</h2>
    <div class="description"> This propagator automatically detects the await keyword and enables async mode. </div>

    <div class="section">
      <div class="controls">
        <button id="fetchButton2">Fetch data for box 3</button>
      </div>

      <folk-shape id="box3" x="100" y="400" width="200" height="100">Click or use button</folk-shape>
      <folk-shape id="box4" x="400" y="400" width="250" height="100">Updates via auto-detection</folk-shape>

      <folk-event-propagator
        source="#box3"
        target="#box4"
        trigger="click"
        expression="x: to.x + 10
y: to.y + 10
backgroundColor: await fetchRandomColor('Box 4')
textContent: 'Auto: ' + await fetchRandomData('Box 4')"
      ></folk-event-propagator>
    </div>

    <script type="module">
      import '@labs/standalone/folk-shape.ts';
      import '@labs/standalone/folk-event-propagator.ts';

      // Mock API functions
      window.fetchRandomColor = async (label) => {
        const timestamp = new Date().toLocaleTimeString();
        document.getElementById('apiResponse').textContent += `\n[${timestamp}] Started color fetch for ${label}`;

        // Simulate a network delay
        await new Promise((resolve) => setTimeout(resolve, 1500));

        const colors = ['#1E88E5', '#D81B60', '#8E24AA', '#43A047', '#FFB300', '#F4511E'];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];

        document.getElementById('apiResponse').textContent +=
          `\n[${timestamp}] Finished color fetch for ${label}: ${randomColor}`;
        return randomColor;
      };

      window.fetchRandomData = async (label) => {
        const timestamp = new Date().toLocaleTimeString();
        document.getElementById('apiResponse').textContent += `\n[${timestamp}] Started data fetch for ${label}`;

        // Simulate a network delay
        await new Promise((resolve) => setTimeout(resolve, 2000));

        const words = ['Amazing', 'Wonderful', 'Fantastic', 'Spectacular', 'Incredible'];
        const randomWord = words[Math.floor(Math.random() * words.length)];

        document.getElementById('apiResponse').textContent +=
          `\n[${timestamp}] Finished data fetch for ${label}: ${randomWord}`;
        return randomWord;
      };

      // Manual triggers
      document.getElementById('fetchButton1').addEventListener('click', () => {
        const timestamp = new Date().toLocaleTimeString();
        document.getElementById('apiResponse').textContent = `[${timestamp}] Making API calls for Box 1...`;
        document.getElementById('box1').click();
      });

      document.getElementById('fetchButton2').addEventListener('click', () => {
        const timestamp = new Date().toLocaleTimeString();
        document.getElementById('apiResponse').textContent = `[${timestamp}] Making API calls for Box 3...`;
        document.getElementById('box3').click();
      });
    </script>
  </body>
</html>
