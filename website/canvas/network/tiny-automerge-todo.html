<!doctype html>
<html lang="en-us">
  <head>
    <title>Automerge Todo List</title>
    <style>
      * {
        box-sizing: border-box;
      }

      html {
        width: 100%;
        height: 100%;
        position: fixed;
        overflow: hidden;
      }

      body {
        min-height: 100%;
        position: relative;
        margin: 0;
        font-family: Arial, sans-serif;
      }

      folk-shape {
        background: rgb(248, 248, 248);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 12px;
      }

      h3 {
        margin-top: 0;
        margin-bottom: 8px;
        color: #333;
        font-size: 16px;
      }

      .todo-input {
        display: flex;
        margin-bottom: 12px;
      }

      .todo-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        outline: none;
      }

      .todo-input button {
        padding: 8px 16px;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 0 4px 4px 0;
        cursor: pointer;
      }

      .todo-input button:hover {
        background-color: #45a049;
      }

      .todo-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
        max-height: 300px;
        overflow-y: auto;
      }

      .todo-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #f0f0f0;
      }

      .todo-item:hover {
        background-color: #f9f9f9;
      }

      .todo-item input[type='checkbox'] {
        margin-right: 8px;
      }

      .todo-item .todo-text {
        flex: 1;
        word-break: break-word;
      }

      .todo-item .todo-text.completed {
        text-decoration: line-through;
        color: #888;
      }

      .todo-item .delete-btn {
        background: none;
        border: none;
        color: #f44336;
        cursor: pointer;
        font-size: 16px;
        padding: 0 8px;
        opacity: 0.6;
      }

      .todo-item .delete-btn:hover {
        opacity: 1;
      }

      .todo-controls {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
      }

      .todo-counts {
        color: #666;
        font-size: 14px;
      }

      .clear-completed {
        background: none;
        border: none;
        color: #4caf50;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
      }

      .clear-completed:hover {
        text-decoration: underline;
      }

      .document-id {
        font-size: 12px;
        color: #666;
      }

      .storage-info {
        margin-top: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #e8f5e9;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 13px;
      }

      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #323232;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .notification.show {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <!-- Todo List Shape -->
    <folk-shape x="50" y="50" width="400" height="400">
      <h3>Automerge Todo List</h3>

      <!-- Todo Input -->
      <div class="todo-input">
        <input type="text" id="todoInput" placeholder="What needs to be done?" />
        <button id="addTodoBtn">Add</button>
      </div>

      <!-- Todo List -->
      <ul class="todo-list" id="todoList">
        <!-- Todo items will be added here dynamically -->
      </ul>

      <!-- Todo Controls -->
      <div class="todo-controls">
        <div class="todo-counts" id="todoCounts">0 items left</div>
        <button class="clear-completed" id="clearCompletedBtn">Clear completed</button>
      </div>

      <!-- Document Info -->
      <div class="storage-info">
        <div class="document-id" id="documentId"></div>
      </div>
    </folk-shape>

    <!-- Explanation Shape -->
    <folk-shape x="50" y="470" width="400">
      <h3>About</h3>
      <p
        >This todo list uses Automerge to store and synchronize data. Your todos are synchronized automatically using
        the URL hash.</p
      >
      <ul style="padding-left: 20px; font-size: 14px; color: #555">
        <li><strong>Add:</strong> Type a todo and hit Enter or click Add</li>
        <li><strong>Complete:</strong> Click the checkbox next to a todo</li>
        <li><strong>Edit:</strong> Double-click on a todo to edit it</li>
        <li><strong>Delete:</strong> Click the × button on a todo</li>
        <li><strong>Sharing:</strong> Share the URL to collaborate in real-time</li>
      </ul>
    </folk-shape>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script type="module">
      import '@labs/standalone/folk-shape.ts';
      import { FolkAutomerge } from '@labs/FolkAutomerge.ts';

      // DOM Elements
      const todoInput = document.getElementById('todoInput');
      const addTodoBtn = document.getElementById('addTodoBtn');
      const todoList = document.getElementById('todoList');
      const todoCounts = document.getElementById('todoCounts');
      const clearCompletedBtn = document.getElementById('clearCompletedBtn');
      const documentIdElement = document.getElementById('documentId');
      const notification = document.getElementById('notification');

      // Initialize FolkAutomerge with initial state
      const automerge = new FolkAutomerge({ todos: [] });

      // Todo-specific methods (moved from FolkAutomerge.ts)
      const todoActions = {
        addTodo(text) {
          automerge.change((doc) => {
            doc.todos.push({
              id: crypto.randomUUID(),
              text,
              completed: false,
              createdAt: Date.now(),
            });
          });
        },

        toggleTodo(id) {
          automerge.change((doc) => {
            const todo = doc.todos.find((t) => t.id === id);
            if (todo) {
              todo.completed = !todo.completed;
            }
          });
        },

        editTodo(id, newText) {
          automerge.change((doc) => {
            const todo = doc.todos.find((t) => t.id === id);
            if (todo) {
              todo.text = newText;
            }
          });
        },

        deleteTodo(id) {
          automerge.change((doc) => {
            const index = doc.todos.findIndex((t) => t.id === id);
            if (index !== -1) {
              doc.todos.splice(index, 1);
            }
          });
        },

        clearCompleted() {
          automerge.change((doc) => {
            // We need to remove items one by one, starting from the end
            // to avoid index shifting problems
            for (let i = doc.todos.length - 1; i >= 0; i--) {
              if (doc.todos[i].completed) {
                doc.todos.splice(i, 1);
              }
            }
          });
        },
      };

      // Show notification function
      function showNotification(message) {
        notification.textContent = message;
        notification.classList.add('show');

        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }

      // Render the todo list
      function renderTodoList(doc) {
        // Clear the list
        todoList.innerHTML = '';

        // Sort todos by creation date (newest first)
        const sortedTodos = [...doc.todos].sort((a, b) => b.createdAt - a.createdAt);

        // Add each todo to the list
        for (const todo of sortedTodos) {
          const li = document.createElement('li');
          li.className = 'todo-item';
          li.dataset.id = todo.id;

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = todo.completed;
          checkbox.addEventListener('change', () => {
            todoActions.toggleTodo(todo.id);
          });

          const todoText = document.createElement('span');
          todoText.className = todo.completed ? 'todo-text completed' : 'todo-text';
          todoText.textContent = todo.text;

          // Double-click to edit
          todoText.addEventListener('dblclick', () => {
            const newText = prompt('Edit todo:', todo.text);
            if (newText !== null && newText.trim() !== '') {
              todoActions.editTodo(todo.id, newText.trim());
            }
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'delete-btn';
          deleteBtn.textContent = '×';
          deleteBtn.addEventListener('click', () => {
            todoActions.deleteTodo(todo.id);
          });

          li.appendChild(checkbox);
          li.appendChild(todoText);
          li.appendChild(deleteBtn);

          todoList.appendChild(li);
        }

        // Update counts
        const remainingCount = doc.todos.filter((todo) => !todo.completed).length;
        todoCounts.textContent = `${remainingCount} item${remainingCount !== 1 ? 's' : ''} left`;
      }

      // Wait for the document to be ready before setting up the UI
      automerge.whenReady((initialDoc) => {
        // Display document ID
        documentIdElement.textContent = `ID: ${automerge.getDocumentId()}`;

        // Register change handler
        automerge.onChange(renderTodoList);

        // Render initial document state
        renderTodoList(initialDoc);

        // Add a new todo when the add button is clicked
        addTodoBtn.addEventListener('click', () => {
          const text = todoInput.value.trim();
          if (text) {
            todoActions.addTodo(text);
            todoInput.value = '';
            todoInput.focus();
          }
        });

        // Add a new todo when Enter is pressed
        todoInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addTodoBtn.click();
          }
        });

        // Clear completed todos
        clearCompletedBtn.addEventListener('click', () => {
          todoActions.clearCompleted();
        });

        // Show notification that the app is ready
        showNotification('Todo list ready');
      });
    </script>
  </body>
</html>
